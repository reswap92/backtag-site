<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BackTag — Pagamento</title>
  <style>
    :root{ --bg:#F5ECE1; --ink:#141414; --bronze:#A88C66; --card:#FCF7F0; --line:#D2C3AF; }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
      display:flex; min-height:100dvh; align-items:center; justify-content:center; padding:32px;
    }
    .wrap{ max-width:820px; width:100% }
    .logo{ display:flex; justify-content:center; margin:24px 0 22px }
    .logo img{ width:300px; height:auto }
    .card{
      background:var(--card); border:1.5px solid var(--line); border-radius:28px;
      padding:28px 22px; box-shadow:0 18px 40px rgba(0,0,0,.06)
    }
    h1{ text-align:center; font-size:30px; margin:8px 0 10px }
    .summary{ text-align:center; margin:10px 0 14px; line-height:1.5 }
    #paypal-container{ max-width:640px; margin:18px auto 0 }
    .btn-back{
      display:block; text-align:center; background:var(--bronze); color:#fff;
      border:0; border-radius:18px; padding:16px 20px; font-weight:700;
      text-decoration:none; max-width:640px; margin:14px auto 0;
    }
    .small{ text-align:center; font-size:14px; opacity:.9; margin-top:14px }
    .muted{ opacity:.75 }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="logo">
      <img src="logo-backtag.png" alt="BackTag"
           onerror="this.onerror=null; this.src='assets/logo-backtag-300.png';" />
    </div>

    <section class="card">
      <h1 id="page-title">Pagamento</h1>

      <div class="summary">
        <div><strong id="prod-title">—</strong></div>
        <div class="muted">SKU: <span id="prod-sku">—</span> · Q.tà: <span id="prod-qty">—</span></div>
        <div>Prezzo unitario: <span id="prod-unit">—</span></div>
        <div style="margin-top:6px">Totale: <strong id="prod-total">—</strong></div>
      </div>

      <!-- PayPal Smart Buttons -->
      <div id="paypal-container"></div>

      <a class="btn-back" id="back-link" href="shop.html">Torna allo Shop</a>
      <div class="small" id="post-pay-note"></div>
    </section>
  </main>

  <!-- Firebase (per i +10 slot) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD0kpQb-t5aJrMQ9mNnvJgl53Fe8UgPwrc",
      authDomain: "backtag-16de3.firebaseapp.com",
      projectId: "backtag-16de3",
      storageBucket: "backtag-16de3.appspot.com",
      messagingSenderId: "415455463905",
      appId: "1:415455463905:web:abd5e58bdeaaf6e3b9eaa0",
      measurementId: "G-6565LXTZW7"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    async function addTenSlots(){
      const email = localStorage.getItem("email");
      if(!email){ console.warn("Email mancante in localStorage"); return; }

      const ref = doc(db, "users", email);
      const snap = await getDoc(ref);

      if(!snap.exists()){
        await setDoc(ref, { baseSlots: 6, extraSlots: 10, updatedAt: Date.now() });
      }else{
        const curr = Number(snap.data().extraSlots || 0);
        await updateDoc(ref, { extraSlots: curr + 10, updatedAt: Date.now() });
      }
    }
    window.__addTenSlots = addTenSlots;
  </script>

  <!-- PayPal SDK live -->
  <script src="https://www.paypal.com/sdk/js?client-id=Af9_Axhg9ncsuTlpPqrk75Q4J0diJivqFwkJZhoIp4JjaGMubk23V9ukol8bfs0XdkNnY_Dpin5jmSrG&currency=EUR"></script>
  <script>
    (function(){
      const q = new URLSearchParams(location.search);

      // 1) Leggo i parametri dallo Shop
      const paramSku    = q.get('sku');
      const paramTitle  = q.get('title');
      const paramAmount = q.get('amount');
      const paramQty    = q.get('qty');

      // 2) Se ci sono, uso quelli; altrimenti fallback a +10 slot (0,99€)
      const product = (paramSku && paramTitle && paramAmount) ? {
        sku: paramSku,
        title: paramTitle,
        unitPrice: parseFloat(paramAmount),
        qty: parseInt(paramQty || '1', 10),
        isSlots: false
      } : {
        sku: 'ADD-10-SLOTS',
        title: 'BackTag — +10 slot profilo',
        unitPrice: 0.99,
        qty: 1,
        isSlots: true
      };

      const subtotal = product.unitPrice * product.qty;
      const total = subtotal; // se vuoi, qui puoi aggiungere spedizione

      // 3) UI riepilogo
      const $ = s => document.querySelector(s);
      $('#prod-title').textContent = product.title;
      $('#prod-sku').textContent   = product.sku;
      $('#prod-qty').textContent   = product.qty;
      $('#prod-unit').textContent  = `€ ${product.unitPrice.toFixed(2)}`;
      $('#prod-total').textContent = `€ ${total.toFixed(2)}`;
      $('#page-title').textContent = `Totale: € ${total.toFixed(2)} — paga in sicurezza`;

      // Messaggino post-pagamento
      const note = product.isSlots
        ? 'Dopo il pagamento torni al profilo con 10 nuovi slot disponibili.'
        : 'Dopo il pagamento riceverai conferma dell’ordine via email.';
      const backHref = product.isSlots ? 'slot-extra.html' : 'shop.html';
      document.getElementById('post-pay-note').textContent = note;
      document.getElementById('back-link').setAttribute('href', backHref);

      // 4) PayPal: ordine dinamico
      paypal.Buttons({
        style:{ shape:'pill', color:'black', layout:'vertical', label:'paypal' },
        createOrder: (data, actions) => actions.order.create({
          intent:"CAPTURE",
          purchase_units:[{
            amount:{ currency_code:"EUR", value: total.toFixed(2) },
            description: product.title
          }]
        }),
        onApprove: async (data, actions) => {
          await actions.order.capture();
          try {
            if (product.isSlots) {
              await window.__addTenSlots();
              location.href = "profilo.html?paid=slots10";
            } else {
              // acquisto fisico: torna allo shop con conferma
              location.href = `shop.html?ok=1&sku=${encodeURIComponent(product.sku)}`;
            }
          } catch(e){
            console.error(e);
            alert('Pagamento effettuato, ma c’è stato un problema con l’aggiornamento. Contattaci se non vedi il risultato.');
          }
        },
        onError: (err) => {
          console.error('PayPal error', err);
          alert('Pagamento non riuscito. Riprova.');
        }
      }).render('#paypal-container');
    })();
  </script>
</body>
</html>
