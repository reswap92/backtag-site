<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BackTag — Pagamento</title>
  <style>
    :root{ --bg:#F5ECE1; --ink:#141414; --bronze:#A88C66; --card:#FCF7F0; --line:#D2C3AF; }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
      display:flex; min-height:100dvh; align-items:center; justify-content:center; padding:32px;
    }
    .wrap{ max-width:820px; width:100% }
    .logo{ display:flex; justify-content:center; margin:24px 0 22px }
    .logo img{ width:300px; height:auto }
    .card{
      background:var(--card); border:1.5px solid var(--line); border-radius:28px;
      padding:28px 22px; box-shadow:0 18px 40px rgba(0,0,0,.06)
    }
    h1{ text-align:center; font-size:30px; margin:8px 0 10px }
    #paypal-container{ max-width:640px; margin:18px auto 0 }
    .btn-back{
      display:block; text-align:center; background:var(--bronze); color:#fff;
      border:0; border-radius:18px; padding:16px 20px; font-weight:700;
      text-decoration:none; max-width:640px; margin:14px auto 0;
    }
    .small{ text-align:center; font-size:14px; opacity:.9; margin-top:14px }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="logo">
      <!-- cambia il percorso se serve -->
      <img src="assets/logo-backtag-300.png" alt="BackTag"/>
    </div>

    <section class="card">
      <h1>Totale: € 0,99 — paga in sicurezza</h1>

      <!-- PayPal Smart Buttons -->
      <div id="paypal-container"></div>

      <a class="btn-back" href="slot-extra.html">Torna indietro</a>
      <div class="small">Dopo il pagamento torni al profilo con 10 nuovi slot disponibili.</div>
    </section>
  </main>

  <!-- Firebase (inline, niente slots.js) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD0kpQb-t5aJrMQ9mNnvJgl53Fe8UgPwrc",
      authDomain: "backtag-16de3.firebaseapp.com",
      projectId: "backtag-16de3",
      storageBucket: "backtag-16de3.appspot.com",
      messagingSenderId: "415455463905",
      appId: "1:415455463905:web:abd5e58bdeaaf6e3b9eaa0",
      measurementId: "G-6565LXTZW7"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // funzione globale per aggiornare gli slot dopo il pagamento
    async function addTenSlots(){
      const email = localStorage.getItem("email");
      if(!email){ console.warn("Email mancante in localStorage"); return; }

      const ref = doc(db, "users", email);
      const snap = await getDoc(ref);

      if(!snap.exists()){
        // crea il profilo utente con 6 base + 10 extra
        await setDoc(ref, { baseSlots: 6, extraSlots: 10, updatedAt: Date.now() });
      }else{
        const curr = Number(snap.data().extraSlots || 0);
        await updateDoc(ref, { extraSlots: curr + 10, updatedAt: Date.now() });
      }
    }

    // esponi per il codice PayPal sotto (non-module)
    window.__addTenSlots = addTenSlots;
  </script>

  <!-- PayPal SDK live con IL TUO client-id -->
  <script src="https://www.paypal.com/sdk/js?client-id=Af9_Axhg9ncsuTlpPqrk75Q4J0diJivqFwkJZhoIp4JjaGMubk23V9ukol8bfs0XdkNnY_Dpin5jmSrG&currency=EUR"></script>
  <script>
    paypal.Buttons({
      style:{ shape:'pill', color:'black', layout:'vertical', label:'paypal' },
      createOrder: (data, actions) => actions.order.create({
        intent:"CAPTURE",
        purchase_units:[{
          amount:{ currency_code:"EUR", value:"0.99" },
          description:"BackTag - +10 slot"
        }]
      }),
      onApprove: async (data, actions) => {
        await actions.order.capture();         // pagamento ok
        try { await window.__addTenSlots(); }  // aggiorna Firestore
        catch(e){ console.error(e); }
        location.href = "profilo.html?paid=slots10"; // ritorna al profilo
      },
      onError: (err) => {
        console.error('PayPal error', err);
        alert('Pagamento non riuscito. Riprova.');
      }
    }).render('#paypal-container');
  </script>
</body>
</html>
