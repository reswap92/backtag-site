<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat - BackTag</title>
  <style>
    body{font-family:Arial,sans-serif;background:#fefaf6;color:#111;text-align:center;padding:40px;margin:0}
    .logo{width:300px;margin-bottom:20px}
    h1{font-size:28px;margin-bottom:10px}
    p.subtitle{font-size:16px;margin-bottom:20px;color:#555}
    .wrap{max-width:720px;margin:0 auto}
    .thread{background:#fff9f0;border:1px solid #e7dbc9;border-radius:16px;padding:16px;text-align:left;min-height:220px}
    .msg{padding:10px 12px;border-radius:10px;margin-bottom:10px;max-width:80%}
    .from-finder{background:#f0e6d5}
    .from-owner{background:#141414;color:#fff;margin-left:auto}
    .ts{font-size:12px;opacity:.8;margin-top:4px}
    .form{margin-top:16px}
    textarea,input{width:100%;max-width:720px;padding:12px;font-size:16px;border:1px solid #ccc;border-radius:10px;box-sizing:border-box;margin-bottom:10px;background:#fff}
    button{background:#a58c6b;color:#fff;padding:12px 22px;border:none;font-size:16px;border-radius:10px;cursor:pointer}
    #errore{color:#a00;margin-top:12px;font-weight:700}
    .hint{font-size:13px;opacity:.8;margin-top:6px}
  </style>
</head>
<body>
  <img src="logo-backtag.png" alt="Logo BackTag" class="logo" />
  <div class="wrap">
    <h1>Hai trovato un oggetto?</h1>
    <p class="subtitle">Scrivi al proprietario. Tieni aperta questa pagina per vedere le risposte in tempo reale.</p>

    <div class="thread" id="thread">Caricamentoâ€¦</div>
    <div id="errore"></div>

    <div class="form">
      <input id="nome" placeholder="Il tuo nome (opzionale)"/>
      <input id="contatto" placeholder="Contatto per risposta (email o telefono, opzionale)"/>
      <textarea id="messaggio" rows="3" placeholder="Scrivi il tuo messaggio qui..."></textarea><br>
      <button id="inviaBtn">Invia messaggio</button>
      <div class="hint">Suggerimento: conserva questa pagina aperta. Le risposte del proprietario appariranno qui.</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      serverTimestamp,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyD0kpQb-t5aJrMQ9mNnvJgl53Fe8UgPwrc",
      authDomain: "backtag-16de3.firebaseapp.com",
      projectId: "backtag-16de3",
      storageBucket: "backtag-16de3.appspot.com",
      messagingSenderId: "415455463905",
      appId: "1:415455463905:web:abd5e58bdeaaf6e3b9eaa0",
      measurementId: "G-6565LXTZW7"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // --- DOM ---
    const threadEl = document.getElementById("thread");
    const erroreEl = document.getElementById("errore");
    const nomeEl   = document.getElementById("nome");
    const contEl   = document.getElementById("contatto");
    const msgEl    = document.getElementById("messaggio");
    const inviaBtn = document.getElementById("inviaBtn");

    // --- Parametri ---
    const params   = new URLSearchParams(window.location.search);
    const codiceQR = (params.get("code") || "").trim();

    let ownerEmail = null; // email proprietario del QR

    // Geolocalizzazione con timeout (per log scansione)
    function getPositionWithTimeout(timeoutMs = 8000) {
      return new Promise((resolve) => {
        if (!navigator.geolocation) return resolve(null);
        let done = false;
        const timer = setTimeout(()=>{ if(!done){ done=true; resolve(null);} }, timeoutMs);
        navigator.geolocation.getCurrentPosition(
          (pos) => { if(done) return; done=true; clearTimeout(timer);
            resolve({ lat:pos.coords.latitude, lng:pos.coords.longitude, accuracy:pos.coords.accuracy });
          },
          () => { if(done) return; done=true; clearTimeout(timer); resolve(null); },
          { enableHighAccuracy:true, maximumAge:0, timeout:timeoutMs }
        );
      });
    }

    async function init() {
      if (!codiceQR) {
        threadEl.textContent = "QR Code non valido o mancante.";
        inviaBtn.disabled = true;
        return;
      }

      // 1) Trova proprietario dal QR
      const qrSnap = await getDocs(query(collection(db,"qrcodes"), where("code","==", codiceQR)));
      if (qrSnap.empty) {
        threadEl.textContent = "QR Code non trovato o non ancora registrato.";
        inviaBtn.disabled = true;
        return;
      }
      ownerEmail = qrSnap.docs[0].data().email;
      // 2) Log scansione (facoltativo)
      try {
        const gps = await getPositionWithTimeout(8000);
        await addDoc(collection(db, "scansioni"), {
          codice: codiceQR,
          email: ownerEmail,
          userAgent: navigator.userAgent,
          referrer: document.referrer || "",
          time: serverTimestamp(),
          ...(gps ? { lat:gps.lat, lng:gps.lng, accuracy:gps.accuracy } : {})
        });
      } catch (e) {
        console.warn("Log scansione fallito:", e);
      }

      // 3) Ascolta la chat in tempo reale (per questo QR + proprietario)
      const qByCode = query(collection(db,"messaggi"), where("codice","==", codiceQR));
      onSnapshot(qByCode, (snap)=>{
        const all = snap.docs.map(d => d.data());
        // Schema nuovo (toEmail/dir/ts) + eventuali legacy convertiti
        const nuovi  = all.filter(m => m.toEmail === ownerEmail);
        const legacy = all.filter(m => !m.toEmail && m.email === ownerEmail)
                          .map(m => ({ testo:m.testo, dir:(m.from==="owner"?"out":"in"), ts:m.data }));
        const list = [...nuovi, ...legacy].sort((a,b)=>{
          const ta = a.ts?.seconds || a.ts?.toDate?.().getTime()/1000 || 0;
          const tb = b.ts?.seconds || b.ts?.toDate?.().getTime()/1000 || 0;
          return ta - tb;
        });

        if (!list.length){
          threadEl.textContent = "Ancora nessun messaggio. Scrivi il primo!";
          return;
        }
        threadEl.innerHTML = "";
        list.forEach(m=>{
          const div = document.createElement("div");
          const fromOwner = m.dir === "out";
          div.className = "msg " + (fromOwner ? "from-owner" : "from-finder");
          const when = m.ts?.toDate ? m.ts.toDate().toLocaleString()
                   : (m.ts?.seconds ? new Date(m.ts.seconds*1000).toLocaleString() : "");
          div.innerHTML = `<div>${escapeHtml(m.testo || "")}</div>${when?`<div class="ts">${when}</div>`:""}`;
          threadEl.appendChild(div);
        });
        threadEl.scrollTop = threadEl.scrollHeight;
      });

      // 4) Invio messaggio (dir="in", letto=false)
      inviaBtn.onclick = async ()=>{
        const testo = (msgEl.value || "").trim();
        const nome  = (nomeEl.value || "").trim();
        const cont  = (contEl.value || "").trim();
        if (!testo) { alert("Scrivi un messaggio prima di inviare."); return; }
        if (!ownerEmail) { alert("Errore: QR non valido."); return; }

        try{
          await addDoc(collection(db, "messaggi"), {
            codice: codiceQR,
            toEmail: ownerEmail,     // destinatario: proprietario
            fromEmail: null,         // trovante anonimo
            nome: nome || null,
            contatto: cont || null,
            testo,
            dir: "in",               // verso il proprietario
            letto: false,            // per attivare badge sul profilo
            ts: serverTimestamp()
          });
          msgEl.value = "";
        }catch(e){
          console.error("Errore invio:", e);
          erroreEl.textContent = "Errore nell'invio del messaggio.";
        }
      };
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => (
        { "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]
      ));
    }

    init();
  </script>
</body>
</html>
