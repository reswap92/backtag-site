<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profilo - BackTag</title>
  <style>
    body {
      background-color: #fefaf6;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .top-bar {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    .logout-btn {
      background-color: #a58c6b;
      color: white;
      font-weight: bold;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .logout-btn:hover { background-color: #8c7558; }

    .card {
      background-color: #fff9f0;
      padding: 40px;
      border-radius: 24px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      width: 360px;
      text-align: center;
      position: relative;
    }
    .logo { width: 300px; margin: 0 auto 10px; }
    h1 { font-size: 28px; margin-bottom: 10px; color: #222; }

    .qr-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 30px 0;
    }
    .slot {
      position: relative;
      background-color: #f5efe2;
      border-radius: 16px;
      padding: 12px;
      height: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      border: 2px dashed #d4c6aa;
      cursor: pointer;
      box-sizing: border-box;
      overflow: hidden;
    }
    .slot img { width: 60px; height: 60px; margin-bottom: 4px; }
    .slot span { font-size: 28px; color: #a58c6b; }
    .slot-info { font-size: 14px; color: #333; text-align: center; }
    .slot-buttons { display: flex; gap: 6px; }
    .slot-buttons button {
      font-size: 11px; padding: 5px 8px; border: none; border-radius: 6px;
      cursor: pointer; background-color: #a58c6b; color: white;
    }
    .cta { margin-top: 20px; }
    .cta button {
      background-color: #d3b277; color: white; font-weight: bold;
      padding: 14px 32px; font-size: 16px; border: none; border-radius: 12px;
      cursor: pointer;
    }
    .badge-unread {
      position: absolute;
      top: 8px; right: 8px;
      background: #e53935; color: #fff;
      border-radius: 999px; font-size: 11px; line-height: 1;
      padding: 4px 6px; min-width: 18px; text-align: center; font-weight: bold;
      box-shadow: 0 0 0 2px #fff9f0;
      cursor: pointer;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD0kpQb-t5aJrMQ9mNnvJgl53Fe8UgPwrc",
      authDomain: "backtag-16de3.firebaseapp.com",
      projectId: "backtag-16de3",
      storageBucket: "backtag-16de3.appspot.com",
      messagingSenderId: "415455463905",
      appId: "1:415455463905:web:abd5e58bdeaaf6e3b9eaa0",
      measurementId: "G-6565LXTZW7"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);

    const BASE_SLOTS = 6;
    const email = localStorage.getItem("email");

    function renderEmptySlot(slotEl, index) {
      slotEl.style.border = "2px dashed #d4c6aa";
      slotEl.style.backgroundColor = "#f5efe2";
      slotEl.style.cursor = "pointer";
      slotEl.innerHTML = `<span>+</span>`;
      slotEl.onclick = () => location.href = `attiva.html?slot=${index}`;
    }

    function makeQrImg(qrCode, size=100) {
      const img = document.createElement("img");
      img.alt = "QR";
      img.width = size; img.height = size;
      const g = `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chld=L|0&chl=${encodeURIComponent(qrCode)}`;
      const f = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(qrCode)}`;
      img.src = g;
      img.onerror = () => { img.onerror = null; img.src = f; };
      return img;
    }

    function renderFilledSlot(slotEl, index, data) {
      const code  = data.code ?? data.codice ?? "";
      const label = data.label ?? data.nome ?? "QR";

      slotEl.innerHTML = "";
      slotEl.appendChild(makeQrImg(code, 100));

      const info = document.createElement("div");
      info.className = "slot-info";
      info.innerHTML = `<strong>${label}</strong><br><small>${code}</small>`;
      slotEl.appendChild(info);

      const btns = document.createElement("div");
      btns.className = "slot-buttons";
      btns.innerHTML = `
        <button onclick="location.href='attiva.html?slot=${index}'">‚úèÔ∏è</button>
        <button onclick="location.href='monitor.html?code=${encodeURIComponent(code)}'">üìà</button>
      `;
      slotEl.appendChild(btns);

      slotEl.style.border = "2px solid #a58c6b";
      slotEl.style.backgroundColor = "#fff";
      slotEl.style.cursor = "default";
      slotEl.onclick = null;
    }

    async function addUnreadBadgeIfAny(slotEl, qrCode) {
      try {
        const msgRef = collection(db, "messaggi");
        const qMsg   = query(msgRef, where("codice","==", qrCode), where("letto","==", false));
        const snap   = await getDocs(qMsg);
        if (snap.size > 0) {
          const badge = document.createElement("div");
          badge.className = "badge-unread";
          badge.title = "Nuovi messaggi";
          badge.textContent = snap.size > 9 ? "9+" : String(snap.size);
          badge.onclick = (e) => {
            e.stopPropagation();
            location.href = `messaggi.html?code=${encodeURIComponent(qrCode)}`;
          };
          slotEl.appendChild(badge);
        }
      } catch (err) {
        console.error("[Profilo] Errore query messaggi:", err);
      }
    }

    async function getExtraSlots(email){
      try{
        const uRef = doc(db, "users", email);
        const uSnap = await getDoc(uRef);
        if (!uSnap.exists()) return 0;
        const data = uSnap.data();
        return Number(data.extraSlots || 0);
      }catch(e){
        console.error("Errore lettura extraSlots:", e);
        return 0;
      }
    }

    async function buildGrid(totalSlots){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      for (let i = 0; i < totalSlots; i++){
        const el = document.createElement("div");
        el.className = "slot";
        renderEmptySlot(el, i);
        grid.appendChild(el);
      }
      return grid.querySelectorAll(".slot");
    }

    async function caricaQR() {
      if (!email) return;

      const extra = await getExtraSlots(email);
      const total = BASE_SLOTS + Math.max(0, extra);

      const slotElements = await buildGrid(total);

      const qrRef = collection(db, "qrcodes");
      const q     = query(qrRef, where("email","==", email));
      const snap  = await getDocs(q);

      snap.forEach(d => {
        const data  = d.data();
        const index = Number(data.slotIndex);
        const slot  = slotElements[index];
        if (!slot) return;
        renderFilledSlot(slot, index, data);
        addUnreadBadgeIfAny(slot, data.code ?? data.codice ?? "");
      });
    }

    window.addEventListener("DOMContentLoaded", caricaQR);
    window.addEventListener("pageshow", () => caricaQR());

    function logout() {
      localStorage.removeItem("email");
      window.location.href = "index.html";
    }
    window.logout = logout;
  </script>
</head>
<body>
  <div class="top-bar">
    <button class="logout-btn" onclick="logout()">Esci</button>
  </div>

  <div class="card">
    <img src="logo-backtag.png" alt="Logo BackTag" class="logo">
    <h1>Profilo</h1>
    <h3>QR attivi</h3>

    <div id="grid" class="qr-grid"></div>

    <div class="cta">
      <button onclick="window.location.href='slot-extra.html'">
        Attiva ora ‚Äî ‚Ç¨0,99
      </button>
    </div>
  </div>
</body>
</html>
