
  if (!email || isNaN(slot)) {
    alert("Errore: dati mancanti. Torna al profilo.");
    window.location.href = "profilo.html";
  }

  // DOM refs (dopo che il DOM è pronto)
  let codeInput, labelInput, messageInput, deleteBtn;
  const docId = `${email}_${slot}`; // <-- ID fisso per email+slot
  const qrRef = doc(db, "qrcodes", docId);

  async function caricaEsistente() {
    try {
      const snap = await getDoc(qrRef);
      if (snap.exists()) {
        const d = snap.data();
        codeInput.value = d.code || "";
        labelInput.value = d.label || "";
        messageInput.value = d.message || "";
        deleteBtn.style.display = "inline-block";
      } else {
        deleteBtn.style.display = "none";
      }
    } catch (e) {
      console.error("Errore lettura:", e);
      alert("Errore nel caricamento: " + (e?.code || e?.message || e));
    }
  }

  window.registraQR = async () => {
    const code = codeInput.value.trim();
    const label = labelInput.value.trim();
    const message = messageInput.value.trim();
    if (!code || !label || !message) {
      alert("Completa tutti i campi.");
      return;
    }
    try {
      await setDoc(qrRef, {
        email,
        slotIndex: slot,
        code,
        label,
        message,
        createdAt: serverTimestamp(), // se non esiste, Firestore lo imposta comunque
        updatedAt: serverTimestamp()
      }, { merge: true }); // <-- sovrascrive invece di creare duplicati
      alert("✅ Salvato con successo.");
      window.location.href = "profilo.html";
    } catch (e) {
      console.error("Errore salvataggio:", e);
      alert("❌ Errore durante il salvataggio: " + (e?.code || e?.message || e));
    }
  };

  window.eliminaQR = async () => {
    if (!confirm("Sei sicuro di voler eliminare questo QR code?")) return;
    try {
      await deleteDoc(qrRef);
      alert("QR eliminato.");
      window.location.href = "profilo.html";
    } catch (e) {
      console.error("Errore eliminazione:", e);
      alert("Errore durante l'eliminazione: " + (e?.code || e?.message || e));
    }
  };

  window.addEventListener("DOMContentLoaded", () => {
    codeInput = document.getElementById("code");
    labelInput = document.getElementById("label");
    messageInput = document.getElementById("message");
    deleteBtn = document.getElementById("deleteBtn");
    caricaEsistente();
  });
</script>
